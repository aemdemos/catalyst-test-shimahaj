# .github/workflows/draft-aemy-pr.yml
# Manages PR draft state during AEMY workflow execution
# Converts PRs to draft when AEMY is running and back to ready when AEMY completed and aemy-merge label is attached

name: aemy-pr-readiness-check

on:
  pull_request:
    types: [labeled, unlabeled]

permissions:
  pull-requests: write
  contents: read

env:
  BLOCKING_LABELS: "aemy-running,aemy-failed"
  MERGE_LABEL: "aemy-merge"

jobs:
  manage-pr-state:
    name: Manage PR Draft State
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Convert PR to draft while AEMY is running
        if: contains(github.event.pull_request.labels.*.name, 'aemy-running')
        run: |
          gh pr ready --undo ${{ github.event.pull_request.number }} || exit 1
          echo "✅ PR converted to draft"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Prevent merge - PR not ready due to AEMY processing
        if: |
          contains(github.event.pull_request.labels.*.name, 'aemy-running') ||
          contains(github.event.pull_request.labels.*.name, 'aemy-failed')
        run: |
          echo "❌ Cannot merge: AEMY processing in progress or failed"
          exit 1

      - name: Mark PR ready for review after AEMY completion
        if: |
          contains(github.event.pull_request.labels.*.name, env.MERGE_LABEL) && 
          !contains(github.event.pull_request.labels.*.name, 'aemy-running') &&
          !contains(github.event.pull_request.labels.*.name, 'aemy-failed')
        run: |
          gh pr ready ${{ github.event.pull_request.number }} || exit 1
          echo "✅ PR ready for review"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
