# .github/workflows/draft-aemy-pr.yml
# Manages PR draft state during AEMY workflow

name: Auto-draft PR during AEMY run

on:
  pull_request:
    types:
      - opened
      - reopened
      - labeled
      - unlabeled
      - ready_for_review

permissions: write-all

env:
  BLOCKING_LABELS: "aemy-running,aemy-failed"
  AEMY_HELP_LABEL: "aemy-help"
  AEMY_MERGE_LABEL: "aemy-merge"

jobs:
  manage_draft:
    name: Manage PR draft status based on AEMY labels
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Mark PR as draft if needed
        if: contains(github.event.pull_request.labels.*.name, 'aemy-help')
        run: |
          gh pr ready --undo ${{ github.event.pull_request.number }}
          echo "PR #${{ github.event.pull_request.number }} marked as draft"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Mark PR ready for review if needed
        if: contains(github.event.pull_request.labels.*.name, 'aemy-merge') && !contains(github.event.pull_request.labels.*.name, 'aemy-running') && !contains(github.event.pull_request.labels.*.name, 'aemy-failed')
        run: |
          gh pr ready ${{ github.event.pull_request.number }}
          echo "PR #${{ github.event.pull_request.number }} marked ready for review"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
